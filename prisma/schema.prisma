generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id            String    @id
  shop          String    @unique
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?
  plan          String    @default("FREE") // Monetization Tracking
  matchCount    Int       @default(0)      // Monthly usage tracking
}

model PetProfile {
  id          String   @id @default(uuid())
  shop        String
  shopifyId   String   // ID of the customer in Shopify
  name        String
  type        String   @default("Dog") // 'Dog', 'Cat', etc.
  breed       String
  weightGram  Int?     // Stored in grams
  birthday    DateTime? // For Lifecycle Marketing
  attributes  String   // Encrypted, must stay as String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isSelected  Boolean  @default(false)
  
  @@index([shop])      // Critical for tenant isolation performance
  @@index([shop, type]) // Optimization for type filtering
  @@index([shop, breed]) // Optimization for Analytics aggregation
  @@index([shop, shopifyId, isSelected]) // Optimized for fetching active profile
}

model PetProfileSettings {
  id          String   @id @default(uuid())
  shop        String   @unique
  config      Json     @default("{}") // Migrated from String for PostgreSQL
  updatedAt   DateTime @updatedAt
}

model ProductRule {
  id          String   @id @default(uuid())
  shop        String
  name        String
  priority    Int      @default(0)
  conditions  Json     @default("{}") // Migrated from String for PostgreSQL
  productIds  Json     @default("[]") // Migrated from String for PostgreSQL
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([shop, name])
  @@index([shop, isActive]) // Optimized for "Get Active Rules" query
}

model SyncedProduct {
  id          String   @id // Shopify Product ID
  shop        String
  title       String
  updatedAt   DateTime @updatedAt

  @@index([shop])
}

model Job {
  id          String   @id @default(uuid())
  type        String   // "BULK_SYNC", "EMAIL_BLAST"
  status      String   // "PENDING", "PROCESSING", "COMPLETED", "FAILED"
  payload     Json     @default("{}") // Migrated from String for PostgreSQL
  createdAt   DateTime @default(now())
}

model MatchEvent {
  id        String   @id @default(uuid())
  shop      String
  profileId String
  ruleId    String
  createdAt DateTime @default(now())

  @@index([shop])
  @@index([shop, createdAt])
}

model CustomerConsent {
  id        String   @id @default(uuid())
  shop      String
  shopifyId String   // Shopify Customer ID
  isAgreed  Boolean  @default(false)
  updatedAt DateTime @updatedAt

  @@unique([shop, shopifyId])
}

// Track staff access to PII (Personal Identifiable Information)
model AuditLog {
  id          String   @id @default(uuid())
  shop        String
  userId      BigInt?  // Shopify Staff ID
  userName    String?  // Staff Name
  action      String   // e.g., "VIEW_PET_PROFILES_LIST", "VIEW_PET_PROFILE_DETAIL"
  resourceId  String?  // The ID of the specific record accessed
  createdAt   DateTime @default(now())

  @@index([shop])
  @@index([shop, createdAt])
}

// Security Configuration per Merchant
model SecuritySettings {
  id                        String   @id @default(uuid())
  shop                      String   @unique
  limitCollaboratorAccess   Boolean  @default(false) // Toggle to block Shopify Collaborator accounts
  updatedAt                 DateTime @updatedAt
}
