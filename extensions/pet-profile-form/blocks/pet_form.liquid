{{ 'pet-profile-form.css' | asset_url | stylesheet_tag }}

{% style %}
  .pp-container {
    /* Color Overrides */
    --pp-primary: {{ block.settings.color_primary }};
    --pp-primary-hover: {{ block.settings.color_primary | color_darken: 10 }};
    --pp-bg: {{ block.settings.color_bg }};
    --pp-text: {{ block.settings.color_text }};
    --pp-text-sub: {{ block.settings.color_text | color_modify: 'alpha', 0.7 }};
    --pp-border: {{ block.settings.color_border }};
    
    /* Layout Overrides */
    --pp-radius: {{ block.settings.border_radius }}px;
    border-width: {{ block.settings.border_width }}px;
    
    /* Dimensions & Spacing */
    max-width: {{ block.settings.container_width }}px;
    padding-top: {{ block.settings.padding_top }}px;
    padding-bottom: {{ block.settings.padding_bottom }}px;

    /* Shadow Overrides */
    {% case block.settings.shadow_depth %}
      {% when 'none' %}
        --pp-shadow: none;
      {% when 'small' %}
        --pp-shadow: 0 1px 2px rgba(0,0,0,0.05);
      {% when 'medium' %}
        --pp-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      {% when 'large' %}
        --pp-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    {% endcase %}
  }
  
  /* Grid Logic */
  .pp-pet-grid {
    display: grid;
    gap: 16px;
    /* Desktop: 1 column (list) or maybe 2? The original design was list-based. 
       Let's keep default list on desktop for now unless requested otherwise, 
       but mobile logic is requested. */
  }

  @media (max-width: 600px) {
    .pp-pet-grid {
        grid-template-columns: 1fr;
    
    }
  }
  
  /* Apply border width to cards */
  .pp-pet-card, .pp-summary-card, .pp-welcome-card, .pp-login-card, .pp-form-wrapper, .pp-skeleton-card {
    border-width: {{ block.settings.border_width }}px;
  }

  /* Animation Toggle */
  {% unless block.settings.enable_animations %}
    .pp-view, .pp-pet-card, .pp-summary-card, .pp-button, .pp-action-btn, .pp-toast, .pp-skeleton {
      animation: none !important;
      transition: none !important;
    }
  {% endunless %}

  /* Typography Overrides */
  .pp-heading, .pp-welcome-title, .pp-login-title, .pp-summary-title {
    font-size: {{ block.settings.heading_size }}px;
  }
  
  .pp-pet-name {
     font-size: {{ block.settings.heading_size | times: 0.7 | round }}px;
  }
  
  body .pp-container {
    font-size: {{ block.settings.text_size }}px;
  }
{% endstyle %}

<script src="{{ 'pet-profile-form.js' | asset_url }}" defer="defer"></script>

<div class="pp-container" data-customer-id="{{ customer.id }}" data-design-mode="{{ request.design_mode }}">
  {% if request.design_mode %}
    <div class="pp-design-preview">
      <p><strong>Editor Preview:</strong> This form will appear for logged-in customers.</p>
    </div>
  {% endif %}

  {% if customer or request.design_mode %}
    
    <!-- Skeleton Loader (Visible initially to fix CLS) -->
    <div id="pp-skeleton-loader" class="pp-skeleton">
      <div class="pp-skeleton-card">
        <div class="pp-skeleton-icon"></div>
        <div class="pp-skeleton-title"></div>
        <div class="pp-skeleton-text"></div>
        <div class="pp-skeleton-text" style="width: 60%;"></div>
        <div class="pp-skeleton-btn"></div>
      </div>
    </div>
    
    <!-- Welcome View (New User) -->
    <div id="pp-welcome-view" class="pp-view" style="display: none;">
      <div class="pp-welcome-card">
        <div class="pp-welcome-content">
          <div class="pp-welcome-icon">{{ block.settings.welcome_icon }}</div>
          <h2 class="pp-welcome-title">{{ block.settings.welcome_title }}</h2>
          <p class="pp-welcome-text">{{ block.settings.welcome_text }}</p>
          <button id="pp-start-btn" class="pp-button pp-button--primary pp-button--large">
            {{ block.settings.welcome_btn_text }}
          </button>
        </div>
      </div>
    </div>

    <!-- Summary View (Returning User) -->
    <div id="pp-summary-view" class="pp-view" style="display: none;">
      <div class="pp-summary-card">
        <div class="pp-summary-content">
           <div class="pp-summary-icon">{{ block.settings.summary_icon }}</div>
           <div class="pp-summary-text">
             <h3 id="pp-active-pet-name" class="pp-summary-title">Loading...</h3>
             <p id="pp-active-pet-details" class="pp-summary-subtitle"></p>
           </div>
        </div>
        <button id="pp-manage-btn" class="pp-button pp-button--secondary pp-button--small">
          {{ block.settings.manage_btn_text }}
        </button>
      </div>
    </div>

    <!-- Management View (Hidden by default) -->
    <div id="pp-management-view" class="pp-view" style="display: none;">
      <div class="pp-management-container">
        <div class="pp-header">
          <div class="pp-header-top">
             <h2 class="pp-heading">{{ block.settings.manage_title }}</h2>
             <button id="pp-close-management-btn" class="pp-close-btn" aria-label="Close management view">√ó</button>
          </div>
          <p class="pp-subheading">{{ block.settings.manage_subtitle }}</p>
        </div>

        <div id="pet-profile-list" class="pp-pet-grid">
          <div class="pp-loading">
            <span class="pp-spinner"></span> Loading your pets...
          </div>
        </div>

        <div class="pp-divider"></div>

        <div class="pp-form-wrapper">
          <div class="pp-form-header">
            <h3 id="form-title" class="pp-form-title">Add a New Pet</h3>
          </div>
          
          <form id="pet-profile-form" class="pp-form">
            <input type="hidden" name="intent" id="form-intent" value="create">
            <input type="hidden" name="id" id="form-pet-id" value="">
            
            <div class="pp-form-group">
              <label for="pet-name" class="pp-label">Pet Name</label>
              <input type="text" id="pet-name" name="name" class="pp-input" required placeholder="e.g. Fido">
            </div>

            <div class="pp-form-group">
              <label for="pet-breed" class="pp-label">Breed</label>
              <input type="text" id="pet-breed" name="breed" class="pp-input" required placeholder="e.g. Golden Retriever">
            </div>

            <div class="pp-form-group">
              <label for="pet-birthday" class="pp-label">Birthday <span class="pp-label-optional">(Optional)</span></label>
              <input type="date" id="pet-birthday" name="birthday" class="pp-input">
            </div>

            <div class="pp-form-actions">
              <button type="submit" id="form-submit-btn" class="pp-button pp-button--primary">
                Save Pet
              </button>
              <button type="button" id="form-cancel-btn" class="pp-button pp-button--secondary" style="display: none;">
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

  {% else %}
    <!-- Login View -->
    <div class="pp-login-view">
      <div class="pp-login-card">
        <div class="pp-login-icon">{{ block.settings.login_icon }}</div>
        <h2 class="pp-login-title">{{ block.settings.login_title }}</h2>
        <p class="pp-login-text">{{ block.settings.login_text }}</p>
        <a href="{{ routes.account_login_url }}" class="pp-button pp-button--primary">{{ block.settings.login_btn_text }}</a>
      </div>
    </div>
  {% endif %}
</div>

<!-- Toast Container -->
<div id="pp-toast-container" class="pp-toast-container"></div>

{% schema %}
{
  "name": "Pet Profile Form",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "color_primary",
      "label": "Primary Color",
      "default": "#008060"
    },
    {
      "type": "color",
      "id": "color_bg",
      "label": "Background Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "color_text",
      "label": "Text Color",
      "default": "#202223"
    },
    {
      "type": "color",
      "id": "color_border",
      "label": "Border Color",
      "default": "#e1e3e5"
    },
    {
      "type": "header",
      "content": "Design & Layout"
    },
    {
      "type": "range",
      "id": "container_width",
      "min": 400,
      "max": 1600,
      "step": 50,
      "unit": "px",
      "label": "Maximum Width",
      "default": 800
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top Padding",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom Padding",
      "default": 36
    },
    {
      "type": "range",
      "id": "border_radius",
      "min": 0,
      "max": 24,
      "step": 2,
      "unit": "px",
      "label": "Border Radius",
      "default": 8
    },
    {
      "type": "range",
      "id": "border_width",
      "min": 0,
      "max": 4,
      "step": 1,
      "unit": "px",
      "label": "Border Width",
      "default": 1
    },
    {
      "type": "select",
      "id": "shadow_depth",
      "label": "Shadow Depth",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "small", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ],
      "default": "small"
    },
    {
      "type": "range",
      "id": "heading_size",
      "min": 16,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Heading Size",
      "default": 24
    },
    {
      "type": "range",
      "id": "text_size",
      "min": 12,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Body Text Size",
      "default": 14
    },
    {
      "type": "checkbox",
      "id": "enable_animations",
      "label": "Enable animations",
      "default": true
    },
    {
      "type": "header",
      "content": "Text Content"
    },
    {
      "type": "paragraph",
      "content": "--- Welcome Screen ---"
    },
    {
      "type": "text",
      "id": "welcome_icon",
      "label": "Icon/Emoji",
      "default": "üëã"
    },
    {
      "type": "text",
      "id": "welcome_title",
      "label": "Title",
      "default": "Welcome to Pet Matcher!"
    },
    {
      "type": "textarea",
      "id": "welcome_text",
      "label": "Body Text",
      "default": "Create a profile for your furry friend to get personalized product recommendations tailored just for them."
    },
    {
      "type": "text",
      "id": "welcome_btn_text",
      "label": "Button Text",
      "default": "Add Your First Pet"
    },
    {
      "type": "paragraph",
      "content": "--- Login Screen ---"
    },
    {
      "type": "text",
      "id": "login_icon",
      "label": "Icon/Emoji",
      "default": "üîí"
    },
    {
      "type": "text",
      "id": "login_title",
      "label": "Title",
      "default": "Join Pet Matcher"
    },
    {
      "type": "textarea",
      "id": "login_text",
      "label": "Body Text",
      "default": "Log in to create profiles for your pets and unlock personalized product matches."
    },
    {
      "type": "text",
      "id": "login_btn_text",
      "label": "Button Text",
      "default": "Log In to Start"
    },
    {
      "type": "paragraph",
      "content": "--- Dashboard ---"
    },
    {
      "type": "text",
      "id": "summary_icon",
      "label": "Summary Icon",
      "default": "üêæ"
    },
    {
      "type": "text",
      "id": "manage_btn_text",
      "label": "Manage Button Text",
      "default": "Manage Pets"
    },
    {
      "type": "text",
      "id": "manage_title",
      "label": "Management Title",
      "default": "My Pet Profiles"
    },
    {
      "type": "textarea",
      "id": "manage_subtitle",
      "label": "Management Subtitle",
      "default": "Manage your pets to get personalized recommendations."
    }
  ]
}
{% endschema %}
