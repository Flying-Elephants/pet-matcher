{{ 'pet-profile-form.css' | asset_url | stylesheet_tag }}

{% style %}
  :root {
    --pp-primary: {{ block.settings.color_primary }};
    --pp-primary-hover: {{ block.settings.color_primary | color_darken: 10 }};
    --pp-bg: {{ block.settings.color_bg }};
    --pp-text: {{ block.settings.color_text }};
    --pp-text-sub: {{ block.settings.color_text | color_modify: 'alpha', 0.7 }};
    --pp-border: {{ block.settings.color_border }};
    --pp-radius: {{ block.settings.border_radius }}px;
    
    /* Trigger Customization */
    --pp-trigger-bg: {{ block.settings.trigger_bg_color }};
    --pp-trigger-text: {{ block.settings.trigger_text_color }};
  }

  .pp-floating-trigger {
    position: fixed;
    z-index: 9999;
    padding: 0 20px;
    height: 48px;
    border-radius: 24px;
    background-color: var(--pp-trigger-bg);
    color: var(--pp-trigger-text);
    display: none; /* Hidden until loaded and consent checked */
    align-items: center;
    justify-content: center;
    gap: 10px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    border: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 600;
    font-size: 14px;
    white-space: nowrap;

    /* Position Logic */
    {% case block.settings.trigger_position %}
      {% when 'bottom_right' %}
        bottom: {{ block.settings.trigger_offset_y }}px;
        right: {{ block.settings.trigger_offset_x }}px;
      {% when 'bottom_left' %}
        bottom: {{ block.settings.trigger_offset_y }}px;
        left: {{ block.settings.trigger_offset_x }}px;
      {% when 'top_right' %}
        top: {{ block.settings.trigger_offset_y }}px;
        right: {{ block.settings.trigger_offset_x }}px;
      {% when 'top_left' %}
        top: {{ block.settings.trigger_offset_y }}px;
        left: {{ block.settings.trigger_offset_x }}px;
    {% endcase %}
  }

  .pp-floating-trigger:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  }

  .pp-trigger-icon {
    font-size: 18px;
  }

  {% if block.settings.trigger_animation %}
  @keyframes pp-pulse {
    0% { box-shadow: 0 0 0 0 {{ block.settings.trigger_bg_color | color_modify: 'alpha', 0.4 }}; }
    70% { box-shadow: 0 0 0 10px {{ block.settings.trigger_bg_color | color_modify: 'alpha', 0 }}; }
    100% { box-shadow: 0 0 0 0 {{ block.settings.trigger_bg_color | color_modify: 'alpha', 0 }}; }
  }
  .pp-floating-trigger {
    animation: pp-pulse 2s infinite;
  }
  {% endif %}

  .pp-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
  }

  .pp-modal-content {
    background: white;
    width: 95%;
    max-width: {{ block.settings.container_width }}px;
    max-height: 90vh;
    overflow-y: auto;
    border-radius: var(--pp-radius);
    position: relative;
    padding: 0;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
  }

  .pp-container {
    padding: 32px;
    margin: 0 auto;
  }

  @media (max-width: 600px) {
    .pp-trigger-label {
      display: none;
    }
    .pp-floating-trigger {
      width: 48px;
      padding: 0;
      border-radius: 50%;
    }
    .pp-container {
      padding: 20px;
    }
  }

  /* Typography Overrides */
  .pp-heading, .pp-welcome-title, .pp-login-title, .pp-summary-title {
    font-size: {{ block.settings.heading_size }}px;
  }
  
  body .pp-container {
    font-size: {{ block.settings.text_size }}px;
  }

  .pp-disclaimer {
    font-size: 11px;
    color: var(--pp-text-sub);
    margin-top: 12px;
    text-align: center;
    line-height: 1.4;
  }

  body.pp-modal-open {
    overflow: hidden;
  }
{% endstyle %}

<script src="{{ 'pet-profile-form.js' | asset_url }}" defer="defer"></script>

<button id="pp-floating-trigger" class="pp-floating-trigger" aria-label="{{ block.settings.trigger_label }}">
  <span class="pp-trigger-icon">üêæ</span>
  <span class="pp-trigger-label">{{ block.settings.trigger_label }}</span>
</button>

<div id="pp-modal-overlay" class="pp-modal-overlay">
  <div class="pp-modal-content">
    <div class="pp-container" data-customer-id="{{ customer.id }}" data-design-mode="{{ request.design_mode }}">
      {% if customer or request.design_mode %}
        
        <!-- Skeleton Loader -->
        <div id="pp-skeleton-loader" class="pp-skeleton">
          <div class="pp-skeleton-card">
            <div class="pp-skeleton-icon"></div>
            <div class="pp-skeleton-title"></div>
            <div class="pp-skeleton-text"></div>
            <div class="pp-skeleton-text" style="width: 60%;"></div>
            <div class="pp-skeleton-btn"></div>
          </div>
        </div>
        
        <!-- Consent View -->
        <div id="pp-consent-view" class="pp-view" style="display: none;">
          <div class="pp-welcome-card">
            <div class="pp-welcome-content">
              <div class="pp-welcome-icon">üõ°Ô∏è</div>
              <h2 class="pp-welcome-title">Data Usage Agreement</h2>
              <p class="pp-welcome-text">To provide personalized product matching for your pets, we need your consent to process your pet's name, breed, and other attributes.</p>
              <div class="pp-form-actions" style="margin-top: 24px; justify-content: center;">
                <button id="pp-agree-btn" class="pp-button pp-button--primary pp-button--large">
                  I Agree to Data Usage
                </button>
              </div>
              <p class="pp-disclaimer" style="margin-top: 16px;">You can opt-out at any time by deleting your pet profiles.</p>
            </div>
          </div>
        </div>

        <!-- Welcome View -->
        <div id="pp-welcome-view" class="pp-view" style="display: none;">
          <div class="pp-welcome-card">
            <div class="pp-welcome-content">
              <div class="pp-welcome-icon">{{ block.settings.welcome_icon }}</div>
              <h2 class="pp-welcome-title">{{ block.settings.welcome_title }}</h2>
              <p class="pp-welcome-text">{{ block.settings.welcome_text }}</p>
              <button id="pp-start-btn" class="pp-button pp-button--primary pp-button--large">
                {{ block.settings.welcome_btn_text }}
              </button>
            </div>
          </div>
        </div>

        <!-- Summary View -->
        <div id="pp-summary-view" class="pp-view" style="display: none;">
          <div class="pp-summary-card">
            <div class="pp-summary-content">
               <div class="pp-summary-icon">{{ block.settings.summary_icon }}</div>
               <div class="pp-summary-text">
                 <h3 id="pp-active-pet-name" class="pp-summary-title">Loading...</h3>
                 <p id="pp-active-pet-details" class="pp-summary-subtitle"></p>
               </div>
            </div>
            <button id="pp-manage-btn" class="pp-button pp-button--secondary pp-button--small">
              {{ block.settings.manage_btn_text }}
            </button>
          </div>
        </div>

        <!-- Management View -->
        <div id="pp-management-view" class="pp-view" style="display: none;">
          <div class="pp-management-container">
            <div class="pp-header">
              <div class="pp-header-top">
                 <h2 class="pp-heading">{{ block.settings.manage_title }}</h2>
                 <button id="pp-close-management-btn" class="pp-close-btn" aria-label="Close management view">√ó</button>
              </div>
              <p class="pp-subheading">{{ block.settings.manage_subtitle }}</p>
            </div>

            <div id="pet-profile-list" class="pp-pet-grid">
              <div class="pp-loading">
                <span class="pp-spinner"></span> Loading your pets...
              </div>
            </div>

            <div class="pp-divider"></div>

            <div class="pp-form-wrapper">
              <div class="pp-form-header">
                <h3 id="form-title" class="pp-form-title">Add a New Pet</h3>
              </div>
              
              <form id="pet-profile-form" class="pp-form">
                <input type="hidden" name="intent" id="form-intent" value="create">
                <input type="hidden" name="id" id="form-pet-id" value="">
                
                <div class="pp-form-group">
                  <label for="pet-name" class="pp-label">Pet Name</label>
                  <input type="text" id="pet-name" name="name" class="pp-input" required placeholder="e.g. Fido">
                </div>

                <div class="pp-form-group">
                   <label for="pet-type" class="pp-label">Pet Type</label>
                   <div class="pp-searchable-select">
                     <input type="text" id="pet-type-search" class="pp-input pp-search-input" placeholder="Search pet types...">
                     <select id="pet-type" name="type" class="pp-input" required size="5" style="display: none;">
                       <option value="" disabled selected>Select a pet type</option>
                     </select>
                   </div>
                </div>

                <div class="pp-form-group">
                  <label for="pet-breed" class="pp-label">Breed</label>
                  <div class="pp-searchable-select">
                    <input type="text" id="pet-breed-search" class="pp-input pp-search-input" placeholder="Search breeds..." disabled>
                    <select id="pet-breed" name="breed" class="pp-input" required disabled size="5" style="display: none;">
                      <option value="" disabled selected>Select a breed</option>
                    </select>
                  </div>
                </div>

                <div class="pp-form-group">
                  <label for="pet-birthday" class="pp-label">Birthday <span class="pp-label-optional">(Optional)</span></label>
                  <input type="date" id="pet-birthday" name="birthday" class="pp-input">
                </div>

                <div class="pp-form-row">
                  <div class="pp-form-group pp-form-group--weight">
                    <label for="pet-weight" class="pp-label">Weight <span class="pp-label-optional">(Optional)</span></label>
                    <input type="number" id="pet-weight" name="weight" class="pp-input" step="0.1" min="0" placeholder="e.g. 10">
                  </div>
                  <div class="pp-form-group pp-form-group--unit">
                    <label for="pet-weight-unit" class="pp-label">Unit</label>
                    <select id="pet-weight-unit" name="weightUnit" class="pp-input">
                      <option value="kg">kg</option>
                      <option value="lbs">lbs</option>
                    </select>
                  </div>
                </div>

                <div class="pp-form-actions">
                  <button type="submit" id="form-submit-btn" class="pp-button pp-button--primary">
                    Save Pet
                  </button>
                  <button type="button" id="form-cancel-btn" class="pp-button pp-button--secondary" style="display: none;">
                    Cancel
                  </button>
                </div>
                <p class="pp-disclaimer">By saving your pet, you agree to the processing of your pet's data for personalized product matching.</p>
              </form>
            </div>
          </div>
        </div>

      {% else %}
        <!-- Login View -->
        <div class="pp-login-view">
          <div class="pp-login-card">
            <div class="pp-login-icon">{{ block.settings.login_icon }}</div>
            <h2 class="pp-login-title">{{ block.settings.login_title }}</h2>
            <p class="pp-login-text">{{ block.settings.login_text }}</p>
            <a href="{{ routes.account_login_url }}" class="pp-button pp-button--primary">{{ block.settings.login_btn_text }}</a>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Toast Container -->
<div id="pp-toast-container" class="pp-toast-container"></div>

{% schema %}
{
  "name": "Pet Profile Form",
  "target": "body",
  "settings": [
    {
      "type": "header",
      "content": "Floating Button (Trigger)"
    },
    {
      "type": "text",
      "id": "trigger_label",
      "label": "Button Label",
      "default": "Perfect Fit Quiz",
      "info": "Text displayed on the floating action button"
    },
    {
      "type": "select",
      "id": "trigger_position",
      "label": "Button Position",
      "options": [
        { "value": "bottom_right", "label": "Bottom Right" },
        { "value": "bottom_left", "label": "Bottom Left" },
        { "value": "top_right", "label": "Top Right" },
        { "value": "top_left", "label": "Top Left" }
      ],
      "default": "bottom_right"
    },
    {
      "type": "range",
      "id": "trigger_offset_x",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Horizontal Offset",
      "default": 24
    },
    {
      "type": "range",
      "id": "trigger_offset_y",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Vertical Offset",
      "default": 24
    },
    {
      "type": "color",
      "id": "trigger_bg_color",
      "label": "Button Background Color",
      "default": "#008060"
    },
    {
      "type": "color",
      "id": "trigger_text_color",
      "label": "Button Text Color",
      "default": "#ffffff"
    },
    {
      "type": "checkbox",
      "id": "trigger_animation",
      "label": "Enable Pulse Animation",
      "default": true
    },
    {
      "type": "header",
      "content": "Modal Appearance"
    },
    {
      "type": "color",
      "id": "color_primary",
      "label": "Primary Theme Color",
      "default": "#008060",
      "info": "Used for buttons and active states"
    },
    {
      "type": "color",
      "id": "color_bg",
      "label": "Form Background Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "color_text",
      "label": "Form Text Color",
      "default": "#202223"
    },
    {
      "type": "color",
      "id": "color_border",
      "label": "Border Color",
      "default": "#e1e3e5"
    },
    {
      "type": "range",
      "id": "container_width",
      "min": 400,
      "max": 1000,
      "step": 50,
      "unit": "px",
      "label": "Modal Max Width",
      "default": 600
    },
    {
      "type": "range",
      "id": "border_radius",
      "min": 0,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Corner Radius",
      "default": 16
    },
    {
      "type": "header",
      "content": "Typography"
    },
    {
      "type": "range",
      "id": "heading_size",
      "min": 16,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Heading Font Size",
      "default": 24
    },
    {
      "type": "range",
      "id": "text_size",
      "min": 12,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Body Font Size",
      "default": 14
    },
    {
      "type": "header",
      "content": "Welcome View",
      "info": "Settings for the view shown to logged-in customers with no pets"
    },
    {
      "type": "text",
      "id": "welcome_icon",
      "label": "Welcome Icon (Emoji)",
      "default": "üëã"
    },
    {
      "type": "text",
      "id": "welcome_title",
      "label": "Welcome Title",
      "default": "Find the Perfect Fit"
    },
    {
      "type": "textarea",
      "id": "welcome_text",
      "label": "Welcome Description",
      "default": "Our smart logic engine matches your pet to the perfect products based on breed, weight, and age."
    },
    {
      "type": "text",
      "id": "welcome_btn_text",
      "label": "Action Button Label",
      "default": "Add Your First Pet"
    },
    {
      "type": "header",
      "content": "Login View",
      "info": "Settings for the view shown to guest customers"
    },
    {
      "type": "text",
      "id": "login_icon",
      "label": "Login Icon (Emoji)",
      "default": "üîí"
    },
    {
      "type": "text",
      "id": "login_title",
      "label": "Login Title",
      "default": "Unlock Personalization"
    },
    {
      "type": "textarea",
      "id": "login_text",
      "label": "Login Description",
      "default": "Log in to start the Perfect Fit Quiz and get smart breed recommendations."
    },
    {
      "type": "text",
      "id": "login_btn_text",
      "label": "Login Button Label",
      "default": "Log In to Start"
    },
    {
      "type": "header",
      "content": "Management View",
      "info": "Settings for the main pet management dashboard"
    },
    {
      "type": "text",
      "id": "summary_icon",
      "label": "Active Pet Icon (Emoji)",
      "default": "üêæ"
    },
    {
      "type": "text",
      "id": "manage_title",
      "label": "Dashboard Title",
      "default": "Retention Center"
    },
    {
      "type": "textarea",
      "id": "manage_subtitle",
      "label": "Dashboard Subtitle",
      "default": "The 'Perfect Fit' guarantee for all your pets."
    },
    {
      "type": "text",
      "id": "manage_btn_text",
      "label": "Manage Pets Button Label",
      "default": "Manage Pets"
    }
  ]
}
{% endschema %}
